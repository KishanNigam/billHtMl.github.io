@ECHO OFF

REM ***

REM Assign the environment name argument to variable. The environment passed includes the environment variable, i.e. whether test or prod.
REM This is done to keep the batch file in sync with the VisualCron job and
REM allow the job to pass environment value to the batch file, irrespective of the environment.
SET server=%1
echo The server is [%server%].

SET version=%2
echo The version is [%version%].

SET environment=%3
echo The environment is [%environment%].

REM Date Variable Definition
FOR /F "TOKENS=1* DELIMS= " %%A IN ('DATE/T') DO SET CDATE=%%B 
For /f "tokens=2-4 delims=/ " %%a in ('date /t') do (set date=%%a%%b%%c)
REM echo cdate=%cdate%
REM echo date %date%
set year=%date:~4,4%
REM echo year %year%
set month=%date:~0,2%
REM echo month %month%
set yearmonth=%year%%month%
REM echo yearmonth %yearmonth%
SET day=%date:~2,2%
echo day=%day%
SET hour=%time:~0,2%
echo hour-%hour%
IF "%hour:~0,1%" == " " SET hour=0%hour:~1,1%
echo hour=%hour%
SET minute=%time:~3,2%
SET filetimestamp=%year%%month%%day%_%hour%%minute%
echo %filetimestamp%

if %environment%==PROD (
	set archivedir=\\%server%\Server\log\Deployment\Summery_LOCK\archive_Deleted_Locks_file
)
if %environment%==TEST (
	set archivedir=\\%server%\Server\log\Deployment\Summery_LOCK\archive_Deleted_Locks_file
)
if %environment%==UAT (
	SET archivedir=\\%server%\Server\log\Deployment\Summery_LOCK\archive_Deleted_Locks_file
)

SET sourcedir=\\%server%\Server\log\Deployment\Summery_LOCK\SourceDIR\
SET logdir=\\%server%\server\log\Deployment\Summery_LOCK\log
SET sourcefile=session_lock.txt

REM Create the log directory if it does not exist.
SET logdir=%logdir%\%year%
IF NOT EXIST %LogDir%\NUL MKDIR %LogDir%
SET logdir=%logdir%\%yearmonth%
IF NOT EXIST %LogDir%\NUL MKDIR %LogDir%
SET logfilename=%LogDir%\session_lock_%filetimestamp%.log

echo Start time %date% %time%              >>%logfilename%
echo .                                     >>%logfilename%

echo server = [%server%].                  >>%logfilename%
echo version = [%version%].                >>%logfilename%
echo archivedir = [%archivedir%].          >>%logfilename%
echo logdir = [%logdir%].                  >>%logfilename%
echo sourcedir = [%sourcedir%].            >>%logfilename%
echo sourcefile = [%sourcefile%].          >>%logfilename%
echo .                                     >>%logfilename%

echo Executing session_lock.VBS script.       >>%logfilename%
CSCRIPT \\%server%\server\log\Deployment\Summery_LOCK\SUMMARY_Session_LOCK_DLT.vbs %server% %version%               >>%logfilename%
echo Finished session_lock.VBS script.        >>%logfilename%
echo .                                     >>%logfilename%

REM Archive the agt_list.txt file.  DO NOT MOVBE THE FILE.
echo Archiving the [%sourcedir%%sourcefile%] file.                                                                            >>%logfilename%
SET archivedir=%archivedir%\%year%
IF NOT EXIST %archivedir%\NUL MKDIR %archivedir%                                                                               >>%logfilename%
SET archivedir=%archivedir%\%yearmonth%
IF NOT EXIST %archivedir%\NUL MKDIR %archivedir%                                                                               >>%logfilename%
echo Executing COPY [%sourcedir%%sourcefile% %archivedir%\%filetimestamp%_%sourcefile%].                                       >>%logfilename%
IF EXIST %sourcedir%%sourcefile% MOVE %sourcedir%%sourcefile% %archivedir%\%filetimestamp%_%sourcefile%                        >>%logfilename%
echo .                                                                                                                         >>%logfilename%

echo End time %date% %time%                        >>%logfilename%
echo *****************************************     >>%logfilename%
echo .                                             >>%logfilename%
