WITH Statuses AS (
    SELECT
        COMPANY_CODE,
        BANK,
        BANK_ACCOUNT,
        CHECK_NUMBER,
        CHECK_RECON_STATUS,
        CHECK_RECON_DATE,
        Ranking = ROW_NUMBER() OVER (PARTITION BY COMPANY_CODE, BANK, BANK_ACCOUNT, CHECK_NUMBER ORDER BY CHECK_RECON_DATE DESC)
    FROM
        AP_CHECK_STATUS WITH (NOLOCK)
), LatestStatuses AS (
    SELECT
        COMPANY_CODE,
        BANK,
        BANK_ACCOUNT,
        CHECK_NUMBER,
        CHECK_RECON_STATUS,
        CHECK_RECON_DATE
    FROM
        Statuses
    WHERE
        Ranking = 1
)
SELECT
    LTRIM(RTRIM(D.TRAN_HDR_DESC)) + ',' +
    CAST(C.CHECK_AMT AS VARCHAR) + ',' +
    A.CHECK_NUMBER + ',' +
    A.CHECK_RECON_STATUS AS DATA_FIELD
FROM
    LatestStatuses A WITH (NOLOCK)
JOIN
    AP_BSTRN_HEADER C WITH (NOLOCK) ON
    C.COMPANY_CODE = A.COMPANY_CODE AND
    (C.CHECK_NUMBER = A.CHECK_NUMBER OR C.EFT_ADVICE_NUM = A.CHECK_NUMBER) AND
    C.CHECK_RECON_STATUS = A.CHECK_RECON_STATUS AND
    C.CHECK_RECON_DATE = A.CHECK_RECON_DATE AND
    C.BANK = A.BANK AND
    C.BANK_ACCOUNT = A.BANK_ACCOUNT
JOIN
    BSTRN_HEADER D WITH (NOLOCK) ON C.TRAN_ID = D.TRAN_ID
WHERE
    D.SOURCE_CODE = 'APSS';
