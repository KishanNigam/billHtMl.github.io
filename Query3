Dim db, rs, objFSO, objFile
Dim sConnect, sQuery, DATAFilePath

' Define the data file path where the result will be saved
DATAFilePath = "\\bhsieas11\server\custom\log\SB-TestV01\BHSIEAS_Output.txt"

' Create the file system object and the text file
Set objFSO = CreateObject("Scripting.FileSystemObject")
Set objFile = objFSO.CreateTextFile(DATAFilePath, True)

' Establish the database connection
sConnect = "DRIVER={SQL Server};SERVER=NICOSQL108\BHSIEAS_TEST;UID=SYSTEM;Trusted_Connection=yes;DATABASE=EAS;"
Set db = CreateObject("ADODB.Connection")
db.CommandTimeout = 0
db.Open sConnect 

' Open the symmetric key to allow decryption (replace 'YourSymmetricKeyName' with the actual key name)
db.Execute "OPEN SYMMETRIC KEY YourSymmetricKeyName DECRYPTION BY CERTIFICATE YourCertificateName"

' Execute the query with decryption
sQuery = "SELECT DISTINCT CONVERT(VARCHAR(50), DECRYPTBYKEY(C.TIN)) AS DATA_FIELD " & _
         "FROM AP_BSTRN_HEADER C WHERE C.TRAN_ID IN (121092,121093)"
Set rs = db.Execute(sQuery)

' Write the decrypted query results to the text file
If Not rs.EOF Then
    Do Until rs.EOF 
        objFile.WriteLine(rs.Fields("DATA_FIELD").Value)
        rs.MoveNext
    Loop
End If

' Close the symmetric key
db.Execute "CLOSE SYMMETRIC KEY YourSymmetricKeyName"

' Close all objects
rs.Close
Set rs = Nothing
db.Close
Set db = Nothing
objFile.Close
Set objFile = Nothing
Set objFSO = Nothing

WScript.Quit(0)
